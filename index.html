<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tees For A Cause : Design Competition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Scrapbook vibe fonts used by style.css -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@600;700&family=Karla:wght@400;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

  <!-- Shared styles -->
  <link rel="stylesheet" href="style.css">

  <!-- Preload logo (ensure tfac.png is in the same folder) -->
  <link rel="preload" as="image" href="tfac.png" />
</head>
<body class="page-index">
  <!-- Paper-styled card formatted by style.css -->
  <div class="card" role="form" aria-label="Design submission form">
    <div class="header">
      <img class="logo" src="./tfac.png" alt="TFAC logo" />
      <h1>Tees For A Cause : Design Competition</h1>
    </div>

    <p class="hint" style="margin: 0 0 8px 0;">Upload your T‑shirt design and stand a chance to win!</p>

    <!-- Form matches the CSS classes from style.css -->
    <form id="submissionForm" novalidate>
      <div class="row">
        <div>
          <label for="name">Name</label>
          <input id="name" name="name" type="text" placeholder="Your full name" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="email">Email</label>
          <input id="email" name="email" type="email" placeholder="you@example.com" required />
        </div>
      </div>

      <!-- Age (styled like other inputs; numeric on mobile, validated in JS) -->
      <div class="row">
        <div>
          <label for="age">Age</label>
          <input id="age" name="age" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 16" required />
          <div class="hint">Enter a number between 5 and 120.</div>
        </div>
      </div>

      <!-- School -->
      <div class="row">
        <div>
          <label for="school">School</label>
          <input id="school" name="school" type="text" placeholder="Your school name" required />
        </div>
      </div>

      <!-- Why interested -->
      <div class="row">
        <div>
          <label for="interest">Why are you interested in participating?</label>
          <textarea id="interest" name="interest" placeholder="Tell us what motivated you to join…"></textarea>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="details">Design Details (max 100 words)</label>
          <textarea id="details" name="details" placeholder="Describe your design concept..."></textarea>
          <div class="hint"><span id="detailsCount">0</span>/100 words</div>
        </div>
      </div>

      <div class="row">
        <div class="file-group">
          <label for="image">Upload Design</label>
          <!-- Hidden native file input (styled via the custom button) -->
          <input id="image" name="image" type="file" accept="image/jpeg,image/png,image/webp" />
          <div class="file-actions">
            <button id="pickFileBtn" class="btn" type="button" aria-controls="image">Choose image</button>
            <div id="fileName" class="file-name" aria-live="polite">No file chosen</div>
          </div>

          <div class="hint">Max 25MB. JPG, PNG, or WebP.</div>

          <!-- Polaroid preview styled by style.css -->
          <div id="preview" class="preview" aria-live="polite">
            <img id="previewImg" alt="Selected image preview" />
            <div id="previewMeta" class="meta"></div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="submitBtn" class="btn" type="submit">Submit entry</button>
        <div id="status" class="status" role="status" aria-live="polite"></div>
      </div>
    </form>
  </div>

  <!-- Thank-you card uses the same paper styling -->
  <div id="thanks" class="wrap" role="status" aria-live="polite" hidden>
    <img class="logo" src="./tfac.png" alt="TFAC logo" />
    <h1 style="margin: 8px 0 8px 0;">Submission received!</h1>
    <p class="hint" style="margin: 0;">Thank you for participating. We’ll be in touch soon.</p>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // Supabase Config (public anon key only)
    const SUPABASE_URL = "https://gmgynepoxilolfabbmwc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtZ3luZXBveGlsb2xmYWJibXdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTI3NTUsImV4cCI6MjA3NjI2ODc1NX0.wP87opUoux8v2aKhTwfrhMgVPTQxBALGLY6nyl_nTHs";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Target table (public.submissions)
    const TABLE = "submissions"; // default schema is 'public'

    // Storage bucket
    const BUCKET = "tfac-uploads";

    const MAX_FILE_BYTES = 25 * 1024 * 1024;
    const ALLOWED_TYPES = ["image/jpeg", "image/png", "image/webp"];
    const MAX_WORDS = 100;

    const form = document.getElementById("submissionForm");
    const submitBtn = document.getElementById("submitBtn");
    const statusEl = document.getElementById("status");

    const imageInput = document.getElementById("image");
    const pickFileBtn = document.getElementById("pickFileBtn");
    const fileNameEl = document.getElementById("fileName");
    const preview = document.getElementById("preview");
    const previewImg = document.getElementById("previewImg");
    const previewMeta = document.getElementById("previewMeta");

    const detailsEl = document.getElementById("details");
    const detailsCountEl = document.getElementById("detailsCount");

    const thanks = document.getElementById("thanks");
    const card = document.querySelector(".card");

    // Track measured image dimensions so we can store them too
    let measuredWidth = null;
    let measuredHeight = null;

    // Helper: word count
    const wordCount = (str) => {
      const tokens = str.trim().split(/\s+/).filter(Boolean);
      return tokens.length === 1 && tokens[0] === "" ? 0 : tokens.length;
    };

    // Live word limit enforcement for details (100 words)
    detailsEl.addEventListener("input", () => {
      const tokens = detailsEl.value.trim().split(/\s+/).filter(Boolean);
      if (tokens.length > MAX_WORDS) {
        detailsEl.value = tokens.slice(0, MAX_WORDS).join(" ");
      }
      detailsCountEl.textContent = wordCount(detailsEl.value);
    });

    // Custom button triggers native file picker
    pickFileBtn.addEventListener("click", () => imageInput.click());

    // Update filename, validate, and show preview
    imageInput.addEventListener("change", () => {
      const file = imageInput.files?.[0];
      if (!file) {
        fileNameEl.textContent = "No file chosen";
        preview.style.display = "none";
        previewImg.removeAttribute("src");
        previewMeta.textContent = "";
        measuredWidth = measuredHeight = null;
        return;
      }

      fileNameEl.textContent = file.name;

      if (!ALLOWED_TYPES.includes(file.type)) {
        setError("Unsupported file type. Only JPG, PNG, or WebP are allowed.");
        imageInput.value = "";
        preview.style.display = "none";
        return;
      }
      if (file.size > MAX_FILE_BYTES) {
        setError("File is too large (max 25MB).");
        imageInput.value = "";
        preview.style.display = "none";
        return;
      }

      const url = URL.createObjectURL(file);
      previewImg.onload = () => {
        const { naturalWidth: w, naturalHeight: h } = previewImg;
        measuredWidth = w;
        measuredHeight = h;
        previewMeta.textContent = `${file.name} • ${(file.size / 1024 / 1024).toFixed(2)} MB • ${file.type} • ${w}×${h}px`;
        URL.revokeObjectURL(url);
      };
      previewImg.onerror = () => {
        measuredWidth = measuredHeight = null;
        previewMeta.textContent = "Could not load preview.";
        URL.revokeObjectURL(url);
      };
      previewImg.src = url;
      preview.style.display = "block";
      clearStatus();
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearStatus();

      const name = form.name.value.trim();
      const email = form.email.value.trim();
      const ageRaw = form.age.value.trim();
      const school = form.school.value.trim();
      const interest = form.interest.value.trim();
      const details = form.details.value.trim();
      const file = imageInput.files?.[0];

      // Validation
      if (!name) return setError("Please enter your name.");
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return setError("Please enter a valid email.");
      if (!ageRaw || isNaN(Number(ageRaw)) || Number(ageRaw) < 5 || Number(ageRaw) > 120) return setError("Please enter a valid age (5–120).");
      if (!school) return setError("Please enter your school.");
      if (!file) return setError("Please choose an image.");
      if (!ALLOWED_TYPES.includes(file.type)) return setError("Unsupported file type.");
      if (file.size > MAX_FILE_BYTES) return setError("File is too large (max 25MB).");
      if (wordCount(details) > MAX_WORDS) return setError("Please limit your design description to 100 words.");

      submitBtn.disabled = true;
      setStatus("Uploading your submission…");

      try {
        // 1) Upload image to Storage
        const sanitized = file.name.replace(/[^a-zA-Z0-9.\-_ ]/g, "_").replace(/\s+/g, "-").toLowerCase();
        const filePath = `submissions/${Date.now()}_${sanitized}`;

        const { error: uploadError } = await supabase.storage
          .from(BUCKET)
          .upload(filePath, file);

        if (uploadError) throw uploadError;

        // 2) Get public URL
        const { data: publicUrlData, error: urlErr } = supabase.storage
          .from(BUCKET)
          .getPublicUrl(filePath);
        if (urlErr) throw urlErr;
        const imageUrl = publicUrlData.publicUrl;

        // 3) Build full payload with ALL inputs (and useful image metadata)
        const payload = {
          name,
          email,
          age: Number(ageRaw),
          school,
          interest,                // WHY they’re participating
          details,                 // design description (<=100 words)
          image_url: imageUrl,     // public URL to the uploaded image
          image_original_name: file.name,
          image_sanitized_name: sanitized,
          image_mime: file.type,
          image_size_bytes: file.size,
          image_width: measuredWidth,   // may be null if preview failed
          image_height: measuredHeight, // may be null if preview failed
          submitted_at: new Date().toISOString(),
        };

        // 4) Insert row with all fields into public.submissions
        const { error: insertError } = await supabase
          .from(TABLE) // public.submissions
          .insert([payload]);

        if (insertError) throw insertError;

        setStatus("Submission successful!");
        // Show styled thank-you card
        card.hidden = true;
        thanks.hidden = false;
        window.scrollTo({ top: 0, behavior: "smooth" });
      } catch (err) {
        console.error(err);
        setError(err?.message || "Something went wrong. Please try again.");
      } finally {
        submitBtn.disabled = false;
      }
    });

    function setStatus(msg) {
      statusEl.textContent = msg;
      statusEl.classList.remove("error");
    }
    function setError(msg) {
      statusEl.textContent = msg;
      statusEl.classList.add("error");
    }
    function clearStatus() {
      statusEl.textContent = "";
      statusEl.classList.remove("error");
    }
  </script>
</body>
</html>