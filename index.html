<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://btjetspsolaoeqvoywqe.supabase.co",
  "YOUR_ANON_KEY"
);

const form = document.getElementById("form");
const statusEl = document.getElementById("status");

form.addEventListener("submit", async e => {
  e.preventDefault();
  statusEl.textContent = "";

  const file = form.image.files[0];
  if (!file) {
    statusEl.textContent = "Payment screenshot is required.";
    statusEl.className = "status error";
    return;
  }

  // hard size limit (IMPORTANT)
  if (file.size > 600_000) {
    statusEl.textContent = "Image too large. Upload under 600 KB.";
    statusEl.className = "status error";
    return;
  }

  const reader = new FileReader();

  reader.onload = async () => {
    const dataUrl = reader.result; // FULL data:image/...;base64,...
    const base64 = dataUrl.split(",")[1];

    const { error } = await supabase
      .from("submissions")
      .insert({
        name: form.name.value.trim(),
        email: form.email.value.trim(),
        age: Number(form.age.value),
        tshirt_size: form.size.value,
        phone: Number(form.phone.value),

        payment_image_base64: base64,
        payment_image_type: file.type,
        payment_image_url: dataUrl
      });

    if (error) {
      statusEl.textContent = error.message;
      statusEl.className = "status error";
      return;
    }

    statusEl.textContent = "Registration submitted successfully!";
    form.reset();
  };

  reader.readAsDataURL(file);
});
</script>
